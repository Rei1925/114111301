<!doctype html>
<html lang="zh-Hant">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>è±ªè¯åˆ®åˆ®æ¨‚</title>
		<link rel="stylesheet" href="styles.css">
		
		<!-- small inline tweaks (kept minimal) -->
		<style>
			/* ensure canvas is on top where needed */
			#scratch{touch-action: none;}
			/* éˆ”ç¥¨å’Œç¡¬å¹£çš„ç´°ç¯€æ¨£å¼ */
			.money-note::before {
				content: '';
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 70%;
				height: 70%;
				border: 2px solid rgba(180,220,140,0.3);
				border-radius: 4px;
			}
			.money-note::after {
				content: '$';
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				font-size: 24px;
				color: rgba(120,180,80,0.25);
				font-weight: bold;
				text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
			}
			.money-note.small::after {
				font-size: 18px;
			}
			.coin::before {
				content: '';
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 80%;
				height: 80%;
				border: 2px solid rgba(255,200,80,0.4);
				border-radius: 50%;
			}
			.coin::after {
				content: 'Â¥';
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				font-size: 20px;
				color: rgba(180,120,20,0.35);
				font-weight: bold;
				text-shadow: 1px 1px 0 rgba(255,255,255,0.6);
			}
			/* history record styles */
			.r-count {
				background: #ffb84d;
				color: #4a3000;
				padding: 1px 6px;
				border-radius: 8px;
				margin-left: 8px;
				font-size: 0.9em;
				font-weight: bold;
			}
			.r-time {
				font-size: 0.9em;
				opacity: 0.8;
			}
		</style>
	</head>
	<body>
		<div class="stage">
			<div class="coins" aria-hidden></div>
			<!-- è£é£¾å…ƒç´ ï¼šéˆ”ç¥¨èˆ‡ç¡¬å¹£ï¼ˆæ”¾å…¥èˆå°å…§ä»¥ç¢ºä¿å¯è¦‹ï¼‰ -->
			<div class="money-note" aria-hidden><div class="note-pattern"></div></div>
			<div class="money-note small" aria-hidden><div class="note-pattern"></div></div>
			<div class="coin spin" aria-hidden>
				<div class="coin-shine"></div>
				<div class="coin-edge"></div>
			</div>
			<div class="title">
				<div class="logo">è±ªç¦®</div>
				<div>
					<h1 class="neon">è±ªè¯åˆ®åˆ®æ¨‚</h1>
					<div class="subtitle">åˆ®ä¸€åˆ®ï¼Œçœ‹çœ‹ä½ æ˜¯ä¸æ˜¯æœ¬æœŸé ­çå¾—ä¸»ï¼æ”¯æ´è§¸æ§èˆ‡æ»‘é¼ </div>
				</div>
			</div>

			<div class="ticket-wrap">
				<div class="ticket" id="ticket">
					<div class="prize" id="prizeArea">
						<div class="label">æ‚¨çš„çå“</div>
						<div class="amount" id="prizeText">æº–å‚™ä¸­...</div>
					</div>

						<!-- canvas è¦†è“‹åœ¨çå“ä¸Šæ–¹ä½œç‚ºåˆ®åˆ®æ¨‚é®ç½© (åªè¦†è“‹çå“å€) -->
						<canvas id="scratch"></canvas>

						<div class="hint">ç”¨æ»‘é¼ æˆ–æ‰‹æŒ‡åœ¨ä¸Šæ–¹åˆ®é–‹éŠ€ç°å€å¡Šï¼Œåˆ®é–‹ä¸€å®šé¢ç©å³å¯æ­æ›‰ï¼</div>
				</div>

				<div style="width:300px;min-width:240px;color:#f8e8c6">
					<h3 style="margin-top:0">èªªæ˜</h3>
					<p style="color:#f1dca0">é€™å¼µåˆ®åˆ®æ¨‚ä½¿ç”¨ç•«å¸ƒé®ç½©æ¨¡æ“¬åˆ®é™¤æ•ˆæœã€‚æ¯æ¬¡æœƒéš¨æ©Ÿé¸ä¸€å€‹çé …ï¼ˆå«é¼“å‹µçï¼‰ã€‚åˆ®é–‹é”åˆ°é–€æª»å¾Œè‡ªå‹•æ­éœ²ä¸¦æ’­æ”¾æ…¶ç¥å‹•ç•«ã€‚</p>
					<ul style="color:#f8e8c6">
						<li>æ”¯æ´æ‰‹æ©Ÿè§¸æ§èˆ‡æ¡Œé¢æ»‘é¼ </li>
						<li>é»ã€Œå†ç©ä¸€æ¬¡ã€å¯ä»¥é‡ç½®</li>
						<li>è‹¥å¸Œæœ›å®Œæ•´æ­é–‹ï¼Œå¯æŒ‰ã€ŒæŸ¥çœ‹çµæœã€</li>
					</ul>
					<footer>ç¥ä½ å¥½é‹ï¼Œæš´ç™¼åœ¨æœ› ğŸ¤‘</footer>
				</div>
			</div>
			<!-- æ§åˆ¶æŒ‰éˆ•ï¼šæ”¾åœ¨åˆ®åˆ®å¡å¤–ï¼Œé¿å…è¢«é®ç½©è¦†è“‹ -->
			<div style="margin-top:14px;display:flex;gap:10px;align-items:center">
				<button class="btn" id="resetBtn">å†ç©ä¸€æ¬¡</button>
				<button class="btn secondary" id="revealBtn">ç›´æ¥é¡¯ç¤ºçµæœ</button>
				<button class="btn" id="historyToggle">ç´€éŒ„</button>
				<div style="margin-left:8px;color:#f1dca0;font-weight:700">æŒ‰éˆ•ä¹Ÿæ”¯æ´éµç›¤ï¼šæŒ‰ R é‡ç½®ï¼ŒæŒ‰ V é¡¯ç¤ºçµæœ</div>
				<!-- è¿‘æœŸå¾—çé¡¯ç¤ºï¼šç›´æ¥é¡¯ç¤ºæœ€è¿‘å¹¾ç­†ï¼Œä½¿ç”¨è€…å¯ä»¥ä¸ç”¨é–‹æ­·å²é¢æ¿ -->
				<div id="recentList" style="margin-left:14px;display:flex;gap:8px;align-items:center"></div>
			</div>
		</div>

		<div class="modal" id="resultModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
			<div id="modalTitle" style="font-size:20px;font-weight:900">æ­æ›‰çµæœ</div>
			<div id="modalBody" style="margin-top:8px;font-size:18px"></div>
			<div style="margin-top:12px;text-align:right">
				<button class="btn" id="closeModal">å¥½æ£’</button>
			</div>
		</div>

		<div class="confetti" id="confetti"></div>


		<!-- æ­·å²ç´€éŒ„é¢æ¿ï¼ˆé è¨­éš±è—æ–¼ CSSï¼Œå¯ç”¨æŒ‰éˆ• toggle é¡¯ç¤ºï¼‰ -->
		<div class="history-panel" id="historyPanel" style="display:none;">
			<h4>éå»åˆ®å¡ç´€éŒ„</h4>
			<ul class="history-list" id="historyList">
				<li class="history-empty">è¼‰å…¥ä¸­â€¦</li>
			</ul>
			<div class="history-actions">
				<button class="btn secondary" id="clearHistoryBtn">æ¸…é™¤ç´€éŒ„</button>
				<button class="btn" id="closeHistoryBtn">é—œé–‰</button>
			</div>
		</div>

		<script>
			// å°åˆç´„
			// - è®€å–ç•«é¢å°ºå¯¸ï¼Œå»ºç«‹ canvas é®ç½©
			// - æ”¯æ´ pointer events (mouse/touch)
			// - ç´€éŒ„åˆ®é™¤é¢ç©ï¼Œè¶…éé–€æª»è‡ªå‹• reveal

			(function(){
				const prizes = [
					{text:'8888 å…ƒç¾é‡‘', weight:1, big:true},
					{text:'iPhone 1 æ”¯', weight:1, big:true},
					{text:'500 å…ƒè³¼ç‰©é‡‘', weight:3},
					{text:'é›æ’ä¸€å€‹ï¼ˆå…Œæ›åˆ¸ï¼‰', weight:6},
					{text:'å†æ¥å†å²ï¼Œæ˜å¤©è¦‹', weight:30},
					{text:'Lucky æŠ˜æ‰£ 85 æŠ˜', weight:8},
					{text:'VIP æœƒå“¡ 30 å¤©', weight:5}
				];

				const prizeTextEl = document.getElementById('prizeText');
				const canvas = document.getElementById('scratch');
				const ticket = document.getElementById('ticket');
				const prizeArea = document.getElementById('prizeArea');
				const resetBtn = document.getElementById('resetBtn');
				const revealBtn = document.getElementById('revealBtn');
				const modal = document.getElementById('resultModal');
				const modalBody = document.getElementById('modalBody');
				const closeModal = document.getElementById('closeModal');
				const confettiRoot = document.getElementById('confetti');

				let ctx, isDrawing=false, revealed=false, prize=null;

				function pickPrize(){
					// weighted random
					const pool=[];prizes.forEach(p=>{for(let i=0;i<p.weight;i++)pool.push(p)});
					const sel = pool[Math.floor(Math.random()*pool.length)];
					prize = sel;
					prizeTextEl.textContent = sel.text;
				}

				let lastPos = null;
				function resizeCanvas(){
					// åªè¦†è“‹çå“å€ (prizeArea)ï¼Œé¿å…é®ä½æŒ‰éˆ•/èªªæ˜
					const tRect = ticket.getBoundingClientRect();
					const pRect = prizeArea.getBoundingClientRect();
					const left = pRect.left - tRect.left;
					const top = pRect.top - tRect.top;
					const w = Math.min(800, Math.max(120, Math.floor(pRect.width)));
					const h = Math.max(80, Math.floor(pRect.height));

					// æ”¯æ´ DPR ä»¥é¡¯å¾—æ›´ç´°ç·»
					const dpr = window.devicePixelRatio || 1;
					canvas.style.position='absolute';
					canvas.style.left = left + 'px';
					canvas.style.top = top + 'px';
					canvas.style.zIndex = 3;
					canvas.style.width = w + 'px';
					canvas.style.height = h + 'px';
					canvas.width = Math.floor(w * dpr);
					canvas.height = Math.floor(h * dpr);
					const ctx2 = canvas.getContext('2d');
					ctx2.setTransform(dpr,0,0,dpr,0,0);
					drawMask();
				}

				function drawMask(){
					ctx = canvas.getContext('2d');
					// draw silver scratch layer with texture (in CSS pixels thanks to setTransform)
					const g = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
					g.addColorStop(0,'#bdbdbd');g.addColorStop(1,'#d6d6d6');
					ctx.fillStyle = g;
					ctx.fillRect(0,0,canvas.width,canvas.height);
					// metallic streaks: short slanted strokes to imitate lamination
					ctx.save();
					ctx.globalAlpha = 0.14;
					for(let i=0;i<120;i++){
						ctx.beginPath();
						const x = Math.random()*canvas.width;
						const y = Math.random()*canvas.height;
						const len = 20 + Math.random()*80;
						const angle = (Math.PI/12) * (Math.random()*2-1);
						ctx.moveTo(x,y);
						ctx.lineTo(x+Math.cos(angle)*len, y+Math.sin(angle)*len);
						ctx.strokeStyle = (Math.random()>0.5)?'rgba(255,255,255,0.25)':'rgba(0,0,0,0.12)';
						ctx.lineWidth = 1 + Math.random()*2;
						ctx.stroke();
					}
					ctx.restore();
					// add fine speckles
					for(let i=0;i<600;i++){
						ctx.fillStyle = 'rgba(255,255,255,'+(Math.random()*0.06)+')';
						ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, Math.random()*1.6+0.3, Math.random()*1.6+0.3);
					}
					// set composite so subsequent strokes erase (åƒçœŸå¯¦åˆ®æ‰é‡‘å±¬å±¤)
					ctx.globalCompositeOperation = 'destination-out';
					ctx.lineCap = 'round'; ctx.lineJoin = 'round';
				}

				function pointerDown(e){
					if(revealed) return; isDrawing=true; lastPos = getPointerPos(e);
					// immediate small mark
					scratchDot(lastPos);
				}
				function pointerUp(e){isDrawing=false; lastPos=null; checkReveal();}
				function pointerMove(e){ if(!isDrawing) return; const pos = getPointerPos(e); scratchLine(lastPos,pos); lastPos = pos; }

				function getPointerPos(e){
					const rect = canvas.getBoundingClientRect();
					const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
					return {x: (p.clientX - rect.left) , y: (p.clientY - rect.top)};
				}

				function scratchDot(pos){
					const r = 24 + Math.random()*16;  // å¢åŠ åŸºæœ¬é»çš„å¤§å°
					ctx.beginPath(); ctx.arc(pos.x,pos.y,r,0,Math.PI*2); ctx.fill();
					// å¢åŠ æ›´å¤šçš„å™ªé»æ•ˆæœï¼Œä¸¦åŠ å¤§å™ªé»
					for(let i=0;i<8;i++){ 
						ctx.beginPath(); 
						ctx.arc(
							pos.x + (Math.random()-0.5)*r*1.5, 
							pos.y + (Math.random()-0.5)*r*1.5, 
							Math.random()*10+5,  // åŠ å¤§å™ªé»å¤§å°
							0,
							Math.PI*2
						); 
						ctx.fill(); 
					}
				}

				function scratchLine(a,b){
					if(!a) { scratchDot(b); return; }
					const dx = b.x - a.x, dy = b.y - a.y; 
					const dist = Math.hypot(dx,dy);
					const steps = Math.max(1, Math.floor(dist / 6));  // æ¸›å°‘æ­¥æ•¸ä½¿é»æ›´å¯†é›†
					for(let i=0;i<steps;i++){
						const t = i/steps;
						const x = a.x + dx*t + (Math.random()-0.5)*4;  // å¢åŠ éš¨æ©Ÿåç§»
						const y = a.y + dy*t + (Math.random()-0.5)*4;
						ctx.beginPath();
						const size = 20 + Math.random()*24;  // å¢åŠ åˆ®é™¤é»çš„å¤§å°
						ctx.arc(x,y,size,0,Math.PI*2);
						ctx.fill();
					}
					// åŠ å¯¬é€£æ¥ç·šæ¢
					ctx.beginPath(); 
					ctx.moveTo(a.x,a.y); 
					ctx.lineTo(b.x,b.y); 
					ctx.lineWidth = 32;  // åŠ å¯¬ç·šæ¢
					ctx.stroke();
				}

				function checkReveal(){
					// è¨ˆç®—é€æ˜åƒç´ æ¯”ä¾‹ (alpha=0 è¡¨ç¤ºå·²åˆ®é–‹)
					try{
						const img = ctx.getImageData(0,0,canvas.width,canvas.height).data;
						let cleared=0; for(let i=3;i<img.length;i+=4){ if(img[i]===0) cleared++; }
						const total = canvas.width*canvas.height; const ratio = cleared/total;
						if(ratio > 0.38) reveal(true);
					}catch(err){
						// æœ‰äº›ç€è¦½å™¨/æƒ…æ³å¯èƒ½æœƒæ‹’çµ•è·¨åŸŸæˆ–åƒç´ å–æ¨£ï¼Œå‰‡ä¾ç…§å·²æ­ç¤ºæ¨™è¨˜è™•ç†
						console.warn('checkReveal error', err); 
					}
				}

				function reveal(auto, toggle){
					if(revealed && toggle){ 
						revealed = false;
						resizeCanvas();
						revealBtn.textContent = 'ç›´æ¥é¡¯ç¤ºçµæœ';
						return;
					}
					if(!revealed) {
						if(prize.text !== 'å†æ¥å†å²ï¼Œæ˜å¤©è¦‹') {
							modalBody.textContent = prize.text + (prize.big ? ' â€” æ­å–œä½ ï¼' : '');
							modal.classList.add('show');
							if(prize.big) makeConfetti();
							saveRecord(prize);
						}
					}
					revealed = true;
					ctx.clearRect(0,0,canvas.width,canvas.height);
					revealBtn.textContent = 'å›åˆ°åˆ®é™¤æ¨¡å¼';
				}

				function makeConfetti(){
					const colors = ['#ffdd57','#ffd36b','#ff7b7b','#7af3ff','#d4ff7a'];
					for(let i=0;i<40;i++){
						const p = document.createElement('div');p.className='p';
						p.style.background = colors[i%colors.length];
						p.style.left = Math.random()*100 + '%';
						p.style.top = '-10vh';
						p.style.width = (6+Math.random()*8)+'px'; p.style.height = (10+Math.random()*10)+'px';
						p.style.transform = 'rotate('+Math.random()*360+'deg)';
						p.style.animationDelay = (Math.random()*0.3)+'s';
						p.style.opacity = '1';
						p.style.borderRadius = (Math.random()*50)+'%';
						p.style.zIndex = 998;
						confettiRoot.appendChild(p);
						setTimeout(()=>p.remove(),2600);
					}
				}

				function reset(){
					revealed = false;
					modal.classList.remove('show');
					pickPrize();
					resizeCanvas(); // é€™æœƒèª¿ç”¨ drawMask() ä¸¦æ­£ç¢ºè¨­å®š canvas ç‹€æ…‹
					// ç¢ºä¿æŒ‰éˆ•æ–‡å­—æ­£ç¢º
					revealBtn.textContent = 'ç›´æ¥é¡¯ç¤ºçµæœ';
				}

				// event wiring
				window.addEventListener('resize', ()=>{ resizeCanvas(); });
				canvas.addEventListener('pointerdown', pointerDown);
				window.addEventListener('pointerup', pointerUp);
				canvas.addEventListener('pointermove', pointerMove);
				// touch fallback for older browsers
				canvas.addEventListener('touchstart', (e)=>{ pointerDown(e); e.preventDefault(); }, {passive:false});
				canvas.addEventListener('touchmove', (e)=>{ pointerMove(e); e.preventDefault(); }, {passive:false});

				resetBtn.addEventListener('click', ()=>{ reset(); });
				revealBtn.addEventListener('click', ()=>{ reveal(false, true); });
				// keyboard shortcuts
				window.addEventListener('keydown',(e)=>{
					if(e.key.toLowerCase()==='r') reset();
					if(e.key.toLowerCase()==='v') reveal(false);
				});
				closeModal.addEventListener('click', ()=>{ modal.classList.remove('show'); });

				// history UI wiring
				const historyToggle = document.getElementById('historyToggle');
				const historyPanel = document.getElementById('historyPanel');
				const historyList = document.getElementById('historyList');
				const clearHistoryBtn = document.getElementById('clearHistoryBtn');
				const closeHistoryBtn = document.getElementById('closeHistoryBtn');

				function loadRecords(){
					try{return JSON.parse(localStorage.getItem('scratch_records')||'[]')}catch(e){return []}
				}

				function saveRecord(pr){
					// ä¸è¨˜éŒ„"å†æ¥å†å²ï¼Œæ˜å¤©è¦‹"çš„çµæœ
					if(pr.text === 'å†æ¥å†å²ï¼Œæ˜å¤©è¦‹') return;
					
					const arr = loadRecords();
					const now = new Date().toISOString();
					
					// æŸ¥æ‰¾æ˜¯å¦å·²æœ‰ç›¸åŒçå“
					const existingIndex = arr.findIndex(r => r.prize === pr.text);
					if (existingIndex >= 0) {
						// å¦‚æœæ‰¾åˆ°ç›¸åŒçå“ï¼Œæ›´æ–°è¨ˆæ•¸å’Œæœ€æ–°æ™‚é–“
						const existing = arr[existingIndex];
						existing.count = (existing.count || 1) + 1;
						existing.lastAt = now;
						// å°‡æ›´æ–°çš„é …ç›®ç§»åˆ°æœ€å‰é¢
						arr.splice(existingIndex, 1);
						arr.unshift(existing);
					} else {
						// å¦‚æœæ˜¯æ–°çå“ï¼ŒåŠ å…¥æ–°è¨˜éŒ„
						arr.unshift({
							prize: pr.text,
							big: !!pr.big,
							count: 1,
							at: now,
							lastAt: now
						});
					}
					
					if(arr.length>100) arr.pop();
					localStorage.setItem('scratch_records', JSON.stringify(arr));
					renderRecords();
				}

				function renderRecords(){
					const arr = loadRecords();
					if(!arr || arr.length===0){ historyList.innerHTML = '<li class="history-empty">å°šç„¡ç´€éŒ„</li>'; return; }
					historyList.innerHTML = arr.map(r=>{
						const firstTime = new Date(r.at).toLocaleString();
						const countText = r.count > 1 ? `<span class="r-count">Ã—${r.count}</span>` : '';
						const timeText = r.count > 1 
							? `é¦–æ¬¡: ${firstTime}<br>æœ€è¿‘: ${new Date(r.lastAt).toLocaleString()}`
							: firstTime;
						return `<li>
							<div class="r-prize">
								${r.prize}${r.big?'<span class="r-badge">â˜…</span>':''}${countText}
							</div>
							<div class="r-time">${timeText}</div>
						</li>`;
					}).join('');
				}

				historyToggle.addEventListener('click', ()=>{ historyPanel.style.display = historyPanel.style.display==='none' ? 'block' : 'none'; renderRecords(); });
				closeHistoryBtn.addEventListener('click', ()=>{ historyPanel.style.display='none'; });
				clearHistoryBtn.addEventListener('click', ()=>{ localStorage.removeItem('scratch_records'); renderRecords(); });


				// åˆå§‹åŒ–
				pickPrize();
				// ç­‰å¾… DOM layout
				requestAnimationFrame(()=>{ resizeCanvas(); });

			})();
		</script>
	</body>
</html>

